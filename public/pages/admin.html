<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Upload</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    body {
      padding: 20px;
      background: none;
      color: var(--text-light);
      height: auto;
      display: block;
      overflow-y: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: inherit;
    }
    .login-box, .form-box {
      max-width: 500px;
      margin: 20px auto;
      background: var(--card-bg-light);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px var(--card-shadow-light);
      transition: background var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }
    .form-box {
      display: none;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
      color: inherit;
    }
    input, textarea, select {
      width: calc(100% - 24px);
      padding: 10px 12px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
      background: var(--glass-bg-light);
      color: var(--text-light);
      transition: background var(--transition-speed) ease, border-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }
    input::placeholder, textarea::placeholder {
        color: rgba(34, 34, 34, 0.6);
    }
    button {
      margin-top: 20px;
      background: var(--primary-color);
      color: white;
      padding: 10px 18px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 100%;
    }
    button:hover {
      background: #159f8a;
    }
    .logout-btn {
      background: #e74c3c;
      margin-top: 10px;
    }
    .logout-btn:hover {
      background: #c0392b;
    }
    .status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    .status-message.success {
      background: #2ecc71;
      color: white;
      display: block;
    }
    .status-message.error {
      background: #e74c3c;
      color: white;
      display: block;
    }

    /* Dark mode for admin page */
    body.dark {
        color: var(--text-dark);
    }
    body.dark .login-box, body.dark .form-box {
        background: var(--card-bg-dark);
        box-shadow: 0 8px 20px var(--card-shadow-dark);
    }
    body.dark input, body.dark textarea, body.dark select {
        background: var(--glass-bg-dark);
        border-color: rgba(26, 188, 156, 0.5);
        color: var(--text-dark);
    }
    body.dark input::placeholder, body.dark textarea::placeholder {
        color: rgba(224, 224, 224, 0.6);
    }
  </style>
</head>
<body>

  <!-- Login Form -->
  <div class="login-box" id="loginBox">
    <h1>ğŸ” ÄÄƒng Nháº­p Admin</h1>
    <label for="password">Máº­t kháº©u:</label>
    <input type="password" id="password" placeholder="Nháº­p máº­t kháº©u admin..." />
    <button onclick="checkPassword()">ÄÄƒng nháº­p</button>
    <div class="status-message" id="loginStatus"></div>
  </div>

  <!-- Upload Form -->
  <div class="form-box" id="uploadForm">
    <h1>ğŸ› ï¸ Admin Upload</h1>

    <label for="select-type">ğŸ“ Chá»n má»¥c upload:</label>
    <select id="select-type">
      <option value="ipa">IPA</option>
      <option value="dylib">Dylib</option>
      <option value="conf">Conf</option>
    </select>

    <label for="input-name">ğŸ“› TÃªn App/Conf:</label>
    <input type="text" id="input-name" placeholder="VD: Instagram Pro / Shadowrocket VN" />

    <label for="input-icon">ğŸ–¼ï¸ Link Icon (áº£nh):</label>
    <input type="text" id="input-icon" placeholder="https://..." />

    <label for="input-file" id="label-file">ğŸ“¥ Link táº£i file:</label>
    <input type="text" id="input-file" placeholder="https://..." />

    <label for="input-desc">ğŸ“ MÃ´ táº£ sá»­ dá»¥ng:</label>
    <textarea id="input-desc" rows="4" placeholder="Nháº­p mÃ´ táº£ chi tiáº¿t..."></textarea>

    <label for="input-usage" id="label-usage" style="display: none;">ğŸ“ HÆ°á»›ng dáº«n sá»­ dá»¥ng:</label>
    <textarea id="input-usage" rows="4" placeholder="Nháº­p hÆ°á»›ng dáº«n sá»­ dá»¥ng Shadowrocket conf..." style="display: none;"></textarea>

    <label for="input-version" id="label-version">#ï¸âƒ£ PhiÃªn báº£n:</label>
    <input type="text" id="input-version" placeholder="VD: 1.0.0" />

    <label for="input-developer" id="label-developer">ğŸ‘¨â€ğŸ’» NhÃ  phÃ¡t triá»ƒn:</label>
    <input type="text" id="input-developer" placeholder="VD: Cuios" />

    <button onclick="uploadApp()">ğŸ“¤ Upload</button>
    <button class="logout-btn" onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
    <div class="status-message" id="uploadStatus"></div>
  </div>

  <script>
    // Máº¬T KHáº¨U ADMIN (Thay Ä‘á»•i máº­t kháº©u nÃ y!)
    const ADMIN_PASSWORD = '6872'; // âš ï¸ Äá»”I Máº¬T KHáº¨U NÃ€Y!

    const selectType = document.getElementById('select-type');
    const inputFile = document.getElementById('input-file');
    const labelFile = document.getElementById('label-file');
    const inputUsage = document.getElementById('input-usage');
    const labelUsage = document.getElementById('label-usage');
    const inputVersion = document.getElementById('input-version');
    const labelVersion = document.getElementById('label-version');
    const inputDeveloper = document.getElementById('input-developer');
    const labelDeveloper = document.getElementById('label-developer');
    const loginBox = document.getElementById('loginBox');
    const uploadForm = document.getElementById('uploadForm');
    const loginStatus = document.getElementById('loginStatus');
    const uploadStatus = document.getElementById('uploadStatus');

    // Kiá»ƒm tra Ä‘Ã£ Ä‘Äƒng nháº­p chÆ°a (dÃ¹ng sessionStorage)
    if (sessionStorage.getItem('adminLoggedIn') === 'true') {
      showUploadForm();
    }

    function checkPassword() {
      const password = document.getElementById('password').value;
      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminLoggedIn', 'true');
        showUploadForm();
      } else {
        loginStatus.className = 'status-message error';
        loginStatus.textContent = 'âŒ Máº­t kháº©u khÃ´ng Ä‘Ãºng!';
        setTimeout(() => {
          loginStatus.style.display = 'none';
        }, 3000);
      }
    }

    function showUploadForm() {
      loginBox.style.display = 'none';
      uploadForm.style.display = 'block';
    }

    function logout() {
      sessionStorage.removeItem('adminLoggedIn');
      loginBox.style.display = 'block';
      uploadForm.style.display = 'none';
      document.getElementById('password').value = '';
    }

    function adjustFormFields() {
        const type = selectType.value;
        if (type === 'conf') {
            labelFile.textContent = 'ğŸ”— Link Conf (sgmodule):';
            inputUsage.style.display = 'block';
            labelUsage.style.display = 'block';
            inputVersion.style.display = 'none';
            labelVersion.style.display = 'none';
            inputDeveloper.style.display = 'none';
            labelDeveloper.style.display = 'none';
        } else {
            labelFile.textContent = 'ğŸ“¥ Link táº£i file:';
            inputUsage.style.display = 'none';
            labelUsage.style.display = 'none';
            inputVersion.style.display = 'block';
            labelVersion.style.display = 'block';
            inputDeveloper.style.display = 'block';
            labelDeveloper.style.display = 'block';
        }
    }

    selectType.addEventListener('change', adjustFormFields);
    adjustFormFields();

    // Äá»“ng bá»™ Dark Mode tá»« trang cha
    window.addEventListener('message', (event) => {
        if (event.data.type === 'themeChange') {
            if (event.data.theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }
    });

    const savedTheme = sessionStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark');
    }

    async function uploadApp() {
      const type = document.getElementById('select-type').value;
      const name = document.getElementById('input-name').value.trim();
      const icon = document.getElementById('input-icon').value.trim();
      const desc = document.getElementById('input-desc').value.trim();

      let appData = {
          id: `${type}-${Date.now()}`,
          type: type,
          name: name,
          icon: icon,
          desc: desc
      };

      if (type === 'conf') {
          const link = document.getElementById('input-file').value.trim();
          const usage = document.getElementById('input-usage').value.trim();
          if (!name || !icon || !link || !desc || !usage) {
              showStatus('error', 'âš ï¸ Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c cho Conf!');
              return;
          }
          appData.link = link;
          appData.usage = usage;
      } else {
          const fileLink = document.getElementById('input-file').value.trim();
          const version = document.getElementById('input-version').value.trim();
          const developer = document.getElementById('input-developer').value.trim();
          const date = new Date().toISOString().split('T')[0];
          if (!name || !icon || !fileLink || !desc) {
              showStatus('error', 'âš ï¸ Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c!');
              return;
          }
          appData.fileLink = fileLink;
          appData.version = version;
          appData.developer = developer;
          appData.date = date;
      }

      // Gá»­i lÃªn API endpoint
      try {
        showStatus('success', 'â³ Äang upload...');
        const response = await fetch('/api/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ type, data: appData })
        });

        const result = await response.json();
        
        if (response.ok) {
          showStatus('success', `âœ… Upload thÃ nh cÃ´ng vÃ o má»¥c ${type.toUpperCase()}! Trang sáº½ tá»± Ä‘á»™ng táº£i láº¡i...`);
          clearForm();
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          showStatus('error', `âŒ Lá»—i: ${result.error || 'KhÃ´ng thá»ƒ upload'}`);
        }
      } catch (error) {
        showStatus('error', `âŒ Lá»—i káº¿t ná»‘i: ${error.message}`);
      }
    }

    function showStatus(type, message) {
      uploadStatus.className = `status-message ${type}`;
      uploadStatus.textContent = message;
      if (type === 'error') {
        setTimeout(() => {
          uploadStatus.style.display = 'none';
        }, 5000);
      }
    }

    function clearForm() {
      document.getElementById('input-name').value = '';
      document.getElementById('input-icon').value = '';
      document.getElementById('input-file').value = '';
      document.getElementById('input-desc').value = '';
      document.getElementById('input-usage').value = '';
      document.getElementById('input-version').value = '';
      document.getElementById('input-developer').value = '';
    }
  </script>

</body>
</html>
